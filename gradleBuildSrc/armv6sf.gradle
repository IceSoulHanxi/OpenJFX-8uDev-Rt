/*
 * Copyright (c) 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the "Classpath" exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

// Declare some local variables which define the cross tools locations
def sdk=file("/opt/armv6-vfp-03")
def compilerHome=file("/opt/arm-2009q1")

// Declare whether this particular target file applies to the current system
ext.ARMV6SF_CAN_BUILD = IS_LINUX && compilerHome.exists() && sdk.exists()
if (!ARMV6SF_CAN_BUILD) return;

ext.ARMV6SF_PRISM_PIPELINES = ["eglfb", "directfb"] // TODO list others as we get them working

// Libraries end up in the sdk/rt/lib/arm directory for arm builds
ext.ARMV6SF_LIB_DEST = "lib/arm"

// TODO this is garbage. Each target file should define what it includes,
// not what it excludes.
ext.ARMV6SF_JFXRT_JAR_EXCLUDES = [
    "**/*.hlsl",
    "com/sun/glass/ui/win",
    "com/sun/glass/ui/accessible/win",
    "com/sun/prism/d3d",
    "com/sun/prism/es2/gl/win",
    "com/sun/prism/null3d",
    "com/sun/scenario/effect/impl/hw/d3d",
    
    "com/sun/glass/events/mac",
    "com/sun/glass/ui/mac",
    "com/sun/glass/ui/accessible/mac",
    "com/sun/prism/es2/gl/mac",
        
    "com/sun/glass/ui/gtk",
    
    "com/sun/glass/ui/ios",
    
    "com/sun/glass/ui/swt", // SWT glass
    
    "javafx/embed/swing", // Swing Interop
    
    "javafx/embed/swt", // SWT Interop
]

def commonFlags = [
        "-fno-strict-aliasing", "-fPIC", "-fno-omit-frame-pointer", // optimization flags
        "-W", "-Wall", "-Wno-unused", "-Wno-parentheses", "-Werror=implicit-function-declaration"] // warning flags
// Specify the compilation parameters and link parameters
def ccFlags = [
        commonFlags, "-I$JDK_HOME/include", "-I$JDK_HOME/include/linux", "-c",
        IS_DEBUG ? ["-ggdb", "-DVERBOSE"] : "-O2"].flatten()
//ccFlags.addAll(["-Wnon-virtual-dtor", "-Woverloaded-virtual", "-std=c++0x"])
def linkFlags = ["-shared", commonFlags].flatten()

// Specify the compilation parameters and link parameters
def extraCFlags = [
        "-I", "-L",
        ccFlags,
        "-march=armv6", "-mfloat-abi=softfp", "-mfpu=vfp",
        "-I$sdk/usr/include",
        "-D_GNU_SOURCE", "-DOMAP3"].flatten();
def extraLFlags = [
        "-I", "-L",
        linkFlags,
        "-Wl,-rpath-link", "$sdk/usr/lib",
        "-L$sdk/usr/lib"].flatten()

def x11CFlags = [extraCFlags, "-DUSE_XSHM"].flatten()
def x11LFlags = [extraLFlags, "-lX11", "-lXext"].flatten()
def eglCFlags = [extraCFlags].flatten()
def eglLFlags = [extraLFlags].flatten()
def dfbCFlags = ["-I$sdk/usr/include/directfb"]
def dfbLFlags = ["-ldl"]
// TODO dfb.args=disable-module=ps2mouse,disable-module=keyboard

def lensLFlags = [extraLFlags, "-lpthread", "-ludev", "-ldl", "-lm"].flatten()
def glassCFlags = ["-ffast-math"]
def glassLFlags = []

def fontCFlags = [extraCFlags].flatten()
def fontLFlags = [extraLFlags].flatten()

def iioCFlags = [extraCFlags].flatten()
def iioLFlags = [extraLFlags].flatten()

def es2CFlags = [extraCFlags].flatten()
def es2LFlags = [extraLFlags, x11LFlags, eglLFlags].flatten()

def es2EglfbCFlags = [extraCFlags, eglCFlags, "-DIS_EGLFB", "-DLINUX", "-DGRADLE_BUILD"].flatten()
def es2EglfbLFlags = [extraLFlags, eglLFlags].flatten()

def es2X11CFlags = [extraCFlags, eglCFlags, x11CFlags, "-DDEBUG", "-DIS_EGLX11"].flatten()
def es2X11LFlags = [extraLFlags, x11LFlags, eglLFlags].flatten()

def prismSWCFlags = [extraCFlags].flatten()
def prismSWLFlags = [extraLFlags].flatten()

def mediaCFlags = [extraCFlags,
    "-I$sdk/usr/include/gstreamer-0.10",
    "-I$sdk/usr/include/glib-2.0",
    "-I$sdk/usr/lib/arm-linux-gnueabihf/glib-2.0/include",
    "-DENABLE_NATIVE_SOURCE=1", "-DENABLE_GST_FFMPEG=1"].flatten()
def mediaLFlags = [extraLFlags, "-lgstreamer-0.10", "-lgstapp-0.10",
    "-lgstbase-0.10", "-lglib-2.0", "-lgobject-2.0", "-lgmodule-2.0", "-lgthread-2.0"].flatten()

def webCFlags = [extraCFlags].flatten()
def webLFlags = [extraLFlags].flatten()

// libraries to remove from the sdk
//deploy.trim.public.library.filter= \
//  fxavcodecplugin-52.so \
//  fxavcodecplugin-53.so \
//  fxplugins.so \
//  libjfxwebkit.so \
//  libgstplugins-lite.so \
//  libgstreamer-lite.so \
//  libprism-es2-eglx11.so \
//  libglass-lens-fb.so \

//defineProperty("CC", "gcc");
//defineProperty("PRISM_CC", "cc");
//defineProperty("PRISM_SW_CC", "cc");

setupTools("armv6-sf_tools",
    { propFile ->
        ByteArrayOutputStream results = new ByteArrayOutputStream();
        exec {
            commandLine("$sdk/bin/pkg-config", "--cflags", "gtk+-2.0", "gthread-2.0", "xtst");
            setStandardOutput(results);
        }
        propFile << "cflags=" << results.toString().trim() << "\n";

        results = new ByteArrayOutputStream();
        exec {
            commandLine "$sdk/bin/pkg-config", "--libs", "gtk+-2.0", "gthread-2.0", "xtst"
            standardOutput = results
        }
        propFile << "libs=" << results.toString().trim();
    },
    { properties ->
        // TODO ONLY TO BE USED WITH GTK COMPILATION
//        extraCFlags.addAll(properties.getProperty("cflags").split(" "))
//        extraLFlags.addAll(properties.getProperty("libs").split(" "))
    }
)

ext.ARMV6SF_JAVAFX_PLATFORM_PROPERTIES =
"""javafx.platform=eglfb
directfb.glass.platform=Lens
directfb.glass.lens=dfb
directfb.prism.order=sw
directfb.com.sun.javafx.isEmbedded=true
directfb.com.sun.javafx.scene.control.skin.FXVK.cache=true
eglfb.maxTextureSize=2048
eglfb.glass.platform=Lens
eglfb.glass.lens=eglfb
eglfb.prism.order=es2
eglfb.prism.eglfb=true
eglfb.prism.device=true
eglfb.prism.lcdtext=false
eglfb.use.egl=true
eglfb.doNativeComposite=true
eglfb.use.gles2=true
eglfb.embedded=eglfb
eglfb.com.sun.javafx.isEmbedded=true
eglfb.com.sun.javafx.scene.control.skin.FXVK.cache=true
fb.glass.platform=Lens
fb.glass.lens=fb
fb.prism.order=sw
fb.com.sun.javafx.isEmbedded=true
fb.glass.restrictWindowToScreen=true
fb.com.sun.javafx.scene.control.skin.FXVK.cache=true
eglx11.glass.platform=Lens
eglx11.glass.lens=eglx11
eglx11.prism.order=es2
eglx11.prism.eglx11=true
eglx11.prism.device=true
eglx11.prism.lcdtext=false
eglx11.use.egl=true
eglx11.use.gles2=true
eglx11.embedded=eglx11
eglx11.com.sun.javafx.isEmbedded=true
eglx11.com.sun.javafx.scene.control.skin.FXVK.cache=true
gtk.glass.platform=gtk
gtk.prism.order=sw
gtk.com.sun.javafx.isEmbedded=true
gtk.com.sun.javafx.scene.control.skin.FXVK.cache=true
# temp workaround RT-24955
eglfb.prism.disableRegionCaching=true
directfb.prism.disableRegionCaching=true
fb.prism.disableRegionCaching=true
eglx11.prism.disableRegionCaching=true
x11.prism.disableRegionCaching=true"""

def COMPILER = file("$compilerHome/bin/arm-none-linux-gnueabi-gcc").getAbsolutePath()
def LINKER = file("$compilerHome/bin/arm-none-linux-gnueabi-g++").getAbsolutePath()

ext.ARMV6SF_GLASS_VARIANTS = ["eglfb", "directfb", "fb", "eglx11", "gtk"]
ext.ARMV6SF_GLASS_JAVAH_INCLUDE = [
    "com/sun/glass/events/**",
    "com/sun/glass/ui/*",
    "com/sun/glass/ui/lens/*"]

ext.ARMV6SF_GLASS_EGLFB_NATIVE_SOURCE = file("modules/graphics/src/main/native-glass/lens")
ext.ARMV6SF_GLASS_EGLFB_COMPILER = COMPILER
ext.ARMV6SF_GLASS_EGLFB_CC_FLAGS = ["-ffast-math", extraCFlags].flatten()
ext.ARMV6SF_GLASS_EGLFB_LINKER = LINKER
ext.ARMV6SF_GLASS_EGLFB_LINK_FLAGS = [lensLFlags].flatten()

ext.ARMV6SF_GLASS_DIRECTFB_NATIVE_SOURCE = file("modules/graphics/src/main/native-glass/lens")
ext.ARMV6SF_GLASS_DIRECTFB_COMPILER = COMPILER
ext.ARMV6SF_GLASS_DIRECTFB_CC_FLAGS = ["-ffast-math", extraCFlags, "-I$sdk/usr/include/directfb"].flatten()
ext.ARMV6SF_GLASS_DIRECTFB_LINKER = LINKER
ext.ARMV6SF_GLASS_DIRECTFB_LINK_FLAGS = [lensLFlags].flatten()

ext.ARMV6SF_GLASS_FB_NATIVE_SOURCE = file("modules/graphics/src/main/native-glass/lens")
ext.ARMV6SF_GLASS_FB_COMPILER = COMPILER
ext.ARMV6SF_GLASS_FB_CC_FLAGS = ["-ffast-math", extraCFlags].flatten()
ext.ARMV6SF_GLASS_FB_LINKER = LINKER
ext.ARMV6SF_GLASS_FB_LINK_FLAGS = [lensLFlags].flatten()

ext.ARMV6SF_GLASS_EGLX11_NATIVE_SOURCE = file("modules/graphics/src/main/native-glass/lens")
ext.ARMV6SF_GLASS_EGLX11_COMPILER = COMPILER
ext.ARMV6SF_GLASS_EGLX11_CC_FLAGS = ["-ffast-math", extraCFlags].flatten()
ext.ARMV6SF_GLASS_EGLX11_LINKER = LINKER
ext.ARMV6SF_GLASS_EGLX11_LINK_FLAGS = [lensLFlags].flatten()

ext.ARMV6SF_GLASS_GTK_NATIVE_SOURCE = file("modules/graphics/src/main/native-glass/lens")
ext.ARMV6SF_GLASS_GTK_COMPILER = COMPILER
ext.ARMV6SF_GLASS_GTK_CC_FLAGS = ["-ffast-math", extraCFlags].flatten()
ext.ARMV6SF_GLASS_GTK_LINKER = LINKER
ext.ARMV6SF_GLASS_GTK_LINK_FLAGS = [lensLFlags, "-lstdc++"].flatten()

ext.ARMV6SF_DECORA_COMPILER = COMPILER
ext.ARMV6SF_DECORA_CC_FLAGS = extraCFlags
ext.ARMV6SF_DECORA_LINKER = LINKER
ext.ARMV6SF_DECORA_LINK_FLAGS = extraLFlags

ext.ARMV6SF_PRISM_COMMON_JAVAH_INCLUDE = ["com/sun/prism/impl/**/*", "com/sun/prism/PresentableState*"]
ext.ARMV6SF_PRISM_COMMON_NATIVE_SOURCE = file("modules/graphics/src/main/native-prism")
ext.ARMV6SF_PRISM_COMMON_COMPILER = COMPILER
ext.ARMV6SF_PRISM_COMMON_CC_FLAGS = es2CFlags // or es2EglfbCFlags? or es2X11CFlags?
ext.ARMV6SF_PRISM_COMMON_LINKER = LINKER
ext.ARMV6SF_PRISM_COMMON_LINK_FLAGS = es2LFlags // or es2EglfbLFlags or es2X11LFlags?

ext.ARMV6SF_PRISM_SW_JAVAH_INCLUDE = ["com/sun/pisces/**/*"]
ext.ARMV6SF_PRISM_SW_NATIVE_SOURCE = file("modules/graphics/src/main/native-prism-sw")
ext.ARMV6SF_PRISM_SW_COMPILER = COMPILER
ext.ARMV6SF_PRISM_SW_CC_FLAGS = prismSWCFlags
ext.ARMV6SF_PRISM_SW_LINKER = LINKER
ext.ARMV6SF_PRISM_SW_LINK_FLAGS = prismSWLFlags

def closedDir = file("$projectDir/../rt-closed")
ext.ARMV6SF_JAVAFX_FONT_JAVAH_INCLUDE = [
        "com/sun/javafx/font/**/*",
        "com/sun/javafx/text/**/*"]
ext.ARMV6SF_JAVAFX_FONT_NATIVE_SOURCE = [
    file("$closedDir/javafx-font-native/src"),
    file("$closedDir/javafx-font-native/src/layout"),
    file("$closedDir/javafx-font-native/src/layoutfx")]
ext.ARMV6SF_JAVAFX_FONT_COMPILER = COMPILER
ext.ARMV6SF_JAVAFX_FONT_CC_FLAGS = fontCFlags
ext.ARMV6SF_JAVAFX_FONT_LINKER = LINKER
ext.ARMV6SF_JAVAFX_FONT_LINK_FLAGS = fontLFlags

ext.ARMV6SF_IIO_JAVAH_INCLUDE = ["com/sun/javafx/iio/**/*"]
ext.ARMV6SF_IIO_NATIVE_SOURCE = [
    file("$closedDir/javafx-iio-native/src"),
    file("$closedDir/javafx-iio-native/src/libjpeg7")]
ext.ARMV6SF_IIO_COMPILER = COMPILER
ext.ARMV6SF_IIO_CC_FLAGS = iioCFlags
ext.ARMV6SF_IIO_LINKER = LINKER
ext.ARMV6SF_IIO_LINK_FLAGS = iioLFlags

ext.ARMV6SF_PRISM_ES2_JAVAH_INCLUDE = ["com/sun/prism/es2/**/*"]
ext.ARMV6SF_PRISM_ES2_NATIVE_SOURCE = [
    file("$closedDir/prism-es2-native/src"),
    file("$closedDir/prism-es2-native/src/GL"),
    file("$closedDir/prism-es2-native/src/eglfb") // TODO pick eglfb or eglx11 depending on pipeline
]
ext.ARMV6SF_PRISM_ES2_COMPILER = COMPILER
ext.ARMV6SF_PRISM_ES2_CC_FLAGS = es2EglfbCFlags //es2CFlags or es2EglfbCFlags or es2X11CFlags?
ext.ARMV6SF_PRISM_ES2_LINKER = LINKER
ext.ARMV6SF_PRISM_ES2_LINK_FLAGS = es2EglfbLFlags //es2LFlags or es2EglfbLFlags or es2X11LFlags?

/******************************************************************************
 *                                                                            *
 *                         Build Setup Sanity Checks                          *
 *                                                                            *
 *****************************************************************************/

if (!IS_LINUX) throw new Exception("Must be on Linux to compile for armv6-hf")
// TODO Check for presence of cross tools

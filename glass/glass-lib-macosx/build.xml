<?xml version="1.0" encoding="UTF-8"?>

<project name="glass-lib-macosx" default="default" basedir=".">

    <description>Builds, tests, and runs the project Glass (Mac OS X)</description>

    <!-- These two should be set to true before importing build-defs.xml -->
    <property name="jfx.build.needs.gcc.compiler" value="true"/>
    <property name="jfx.build.needs.xcodebuild.utility" value="true"/>
    <property name="jfx.build.needs.make.utility" value="true"/>

    <import file="../../build-defs.xml"/>

    <property name="glass.dist.dir" value="../glass/dist"/>
    <property name="glass.class.dir" value="../glass/build/classes"/>
    <property name="glass-lib.src.dir" value="./src"/>
    <property name="glass-lib.dist.dir" value="./dist"/>
    <property name="glass-lib.build.dir" value="./build"/>
    <property name="glass-lib.name" value="libglass.dylib"/>
    <property name="glass-lib.fullname" value="${glass-lib.dist.dir}/${glass-lib.name}"/>

    <target name="init" depends="-init-defs,-init-platform-defs"/>

    <target name="default" depends="init,compile-native"/>

    <target name="check-native">
      <uptodate property="native.uptodate" targetfile="${glass-lib.fullname}">
        <srcfiles dir="${glass-lib.src.dir}" includes="**/*.h"/>
        <srcfiles dir="${glass-lib.src.dir}" includes="**/*.m"/>
        <srcfiles dir="${glass.dist.dir}" includes="glass.jar"/>
      </uptodate>
    </target>

    <target name="compile-native" depends="init,check-native" unless="native.uptodate">
      <exec executable="make" dir="." failonerror="true">
        <env key="MACOSX_SDK_PATH" value="${macosx.sdk.path}"/>
        <env key="JDK_HOME" value="${platform.home}"/>
        <env key="CONF" value="${build.conf}"/>
        <env key="DIST_DIR" value="${glass-lib.dist.dir}"/>
        <env key="BUILD_DIR" value="${glass-lib.build.dir}"/>
        <env key="CLASS_DIR" value="${glass.class.dir}"/>
        <env key="SRC_DIR" value="${glass-lib.src.dir}"/>
        <env key="OUT_LIB" value="${glass-lib.fullname}"/>
        <arg value="all"/>
      </exec>
      <copy todir="${glass.dist.bin.dir}" flatten="true">
        <fileset file="${glass-lib.fullname}"/>
      </copy>
    </target>

    <target name="clean" depends="clean-native"/>

    <target name="clean-native">
      <exec executable="make" dir="." failonerror="true">
        <env key="DIST_DIR" value="${glass-lib.dist.dir}"/>
        <env key="BUILD_DIR" value="${glass-lib.build.dir}"/>
        <arg value="clean"/>
      </exec>
    </target>

</project>

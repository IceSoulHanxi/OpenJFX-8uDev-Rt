<?xml version="1.0" encoding="UTF-8"?>

<project name="glass-lib-windows" default="default" basedir=".">

    <description>Builds, tests, and runs the project Glass (Windows)</description>

    <!-- These two should be set to true before importing build-defs.xml -->
    <property name="jfx.build.needs.visual.studio" value="true"/>
    <property name="jfx.build.needs.make.utility" value="true"/>

    <import file="../../build-defs.xml"/>

    <!-- The following properties are passed to the native makefile -->
    <property name="glass.dist.dir" value="../glass/dist"/>
    <property name="glass.class.dir" value="../glass/build/classes"/>
    <property name="glass-lib.dist.dir" value="./dist"/>
    <property name="glass-lib.build.dir" value="./build"/>
    <property name="glass-lib.makefile" value="Makefile"/>

    <property name="glass-lib.cpp.dir" value="./src"/>
    <property name="glass-lib.dll.file" value="${glass-lib.dist.dir}/glass.dll"/>

    <target name="check-native">
        <uptodate property="native.uptodate" targetfile="${glass-lib.dll.file}" >
            <srcfiles dir= "${glass-lib.cpp.dir}" includes="*.cpp"/>
            <srcfiles dir= "${glass-lib.cpp.dir}" includes="*.h"/>
            <srcfiles dir= "${glass.dist.dir}" includes="glass.jar"/>
        </uptodate>
    </target>

    <target name="compile-native" depends="check-native" unless="native.uptodate">
        <get-cygwin-path/>
        <exec executable="cygpath" dir="." outputproperty="short.platform.home" failonerror="true">
            <arg value="-m"/>
            <arg value="-s"/>
            <arg value="${platform.home}"/>
        </exec>
        <antcall target="needs-vs-properties"/>
        <property file="${vs.properties}"/>
        <exec executable="${cmd.utility}" dir="." failonerror="true">
            <env key="INCLUDE" value="${windows.vs.INCLUDE}"/>
            <env key="LIB" value="${windows.vs.LIB}"/>
            <env key="LIBPATH" value="${windows.vs.LIBPATH}"/>
            <env key="PATH" value="${windows.vs.PATH}"/>
            <env key="JDK_HOME" value="${short.platform.home}"/>
            <env key="CONF" value="${build.conf}"/>
            <env key="DIST_DIR" value="${glass-lib.dist.dir}"/>
            <env key="BUILD_DIR" value="${glass-lib.build.dir}"/>
            <env key="CLASS_DIR" value="${glass.class.dir}"/>
            <arg value="/C"/>
            <arg value="${make.utility}"/>
            <arg value="-f"/>
            <arg value="${glass-lib.makefile}"/>
            <arg value="all"/>
        </exec>
        <copy todir="${glass.dist.bin.dir}" flatten="true">
            <fileset file="${glass-lib.dll.file}"/>
        </copy>
    </target>

    <target name="default" depends="compile-native"/>

    <target name="clean" depends="init">
        <get-cygwin-path/>
        <property file="${vs.properties}"/>
        <!-- TODO: reuse do-make macro here -->
        <exec executable="${cmd.utility}" dir="." failonerror="true">
            <env key="DIST_DIR" value="${glass-lib.dist.dir}"/>
            <env key="BUILD_DIR" value="${glass-lib.build.dir}"/>
            <arg value="/C"/>
            <arg value="${make.utility}"/>
            <arg value="-f"/>
            <arg value="${glass-lib.makefile}"/>
            <arg value="clean"/>
        </exec>
    </target>
  
</project>

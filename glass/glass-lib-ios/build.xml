<?xml version="1.0" encoding="UTF-8"?>

<project name="glass-lib-ios" default="default" basedir=".">

    <description>Builds, tests, and runs the project Glass (iOS)</description>

    <!-- These two should be set to true before importing build-defs.xml -->
    <property name="jfx.build.needs.gcc.compiler" value="true"/>
    <property name="jfx.build.needs.xcodebuild.utility" value="true"/>
    <property name="jfx.build.needs.make.utility" value="true"/>

    <import file="../../../build-defs.xml"/>

    <property name="glass.dist.dir" value="../glass/dist"/>
    <property name="glass.class.dir" value="../glass/build/classes"/>
    <property name="glass-lib.src.dir" value="./src"/>
    <property name="glass-lib.dist.dir" value="./dist"/>
    <property name="glass-lib.build.dir" value="./build"/>
    <property name="glass-lib.name" value="libglass.a"/>
    <property name="glass-lib.fullname" value="${glass-lib.dist.dir}/${glass-lib.name}"/>

    <target name="default" depends="compile-native"/>

    <target name="check-native">
      <uptodate property="native.uptodate" targetfile="${glass-lib.fullname}">
        <srcfiles dir="${glass-lib.src.dir}" includes="**/*.h"/>
        <srcfiles dir="${glass-lib.src.dir}" includes="**/*.m"/>
        <srcfiles dir="${glass.dist.dir}" includes="glass.jar"/>
      </uptodate>
    </target>

    <target name="compile-native" depends="check-native" unless="native.uptodate">
      <exec executable="make" dir="." failonerror="true">
        <arg value="JDK_HOME=${platform.home}"/>
        <arg value="CONF=${build.conf}"/>
        <arg value="DIST_DIR=${glass-lib.dist.dir}"/>
        <arg value="BUILD_DIR=${glass-lib.build.dir}"/>
        <arg value="CLASS_DIR=${glass.class.dir}"/>
        <arg value="SRC_DIR=${glass-lib.src.dir}"/>
        <arg value="OUT_LIB=${glass-lib.fullname}"/>
        <arg value="EXTRA_CFLAGS=${cross.glass.cflags}"/>
        <arg value="all"/>
      </exec>
      <copy todir="${glass.dist.bin.dir}" flatten="true">
        <fileset file="${glass-lib.fullname}"/>
      </copy>
    </target>

    <target name="clean" depends="clean-native"/>

    <target name="clean-native">
      <exec executable="make" dir="." failonerror="true">
        <arg value="DIST_DIR=${glass-lib.dist.dir}"/>
        <arg value="BUILD_DIR=${glass-lib.build.dir}"/>
        <arg value="clean"/>
      </exec>
    </target>

</project>

<?xml version="1.0" encoding="UTF-8"?>
<project name="BuildTasks" default="default" basedir="."
        xmlns:fx="javafx:com.sun.javafx.tools.ant">
    <description>
        This gets imported into every build.xml generated by netbeans in each app project. It adds
        standard targets for building and distributing apps to the project build targets.
    </description>
    
    <import file="build-defs.xml"/>
    
    <!-- Set location of JFX SDK and Runtime -->
    <property name="javafx.sdk" value="${jfx.sdk.dir}"/>
    <property name="javafx.runtime" value="${jfx.sdk.dir}/rt"/>

    <!-- tasks for deployment and executable jars -->
    <taskdef resource="com/sun/javafx/tools/ant/antlib.xml"      
             uri="javafx:com.sun.javafx.tools.ant"
             classpath="${jfx.sdk.anttask.jar}"/>

    <condition property="isWindows">
        <os family="windows"/>
    </condition>

    <!-- do not support web deployment on platforms other then windows -->
    <target name="web-deploy" if="isWindows">
       <antcall target="-do-deploy"/>
    </target>

    <target name="-do-deploy" unless="deploy.standalone">
        <!-- Generate applet/webstart launchers -->
        <!-- To support it properly we MUST not add Class-Path attribute 
             to manifest (see above) !! -->
        <!-- Other TODO: 
               - do not hardcode sizes!
               - add signing support if needed
               - use custom preloaders -->
        <property name="applet.width" value="600"/>
        <property name="applet.height" value="400"/>
        <fx:deploy embedJNLP="true" nativeBundles="false"
                   width="${applet.width}" height="${applet.height}"
                   outdir="${basedir}/dist"
                   outfile="${application.title}">
            <info title="Sample app: ${application.title}"/>
            <fx:application name="${application.title}"
                  mainClass="${main.class}"/>
            <fx:preferences shortcut="false"/>
            <fx:resources>
               <fx:fileset dir="${basedir}/dist">
                  <include name="${application.title}.jar"/>
               </fx:fileset>
            </fx:resources>
         </fx:deploy>  
    </target>

    <target name="dist-apps-experiments" depends="init">
        <copy todir="${jfx.apps.experiments.dir}">
            <fileset dir="dist">
                <include name="*.jar"/> <!-- should be good to copy -->
                <include name="*.html"/>
                <include name="*.jnlp"/>
                <include name="web-files/*"/>
            </fileset>
        </copy>

        <!-- Copy src files -->
        <mkdir dir="${jfx.apps.experiments.dist}/${application.title}"/>
        <copy todir="${jfx.apps.experiments.dist}/${application.title}">
            <fileset dir="${basedir}">
                <exclude name="**/build/**"/>
                <exclude name="**/dist/**"/>
                <exclude name="**/nbproject/private/**"/>
                <exclude name="**/*.iml"/>
            </fileset>
        </copy>

        <!-- Remove build-tasks import from netbeans projects -->
        <replace dir="${jfx.apps.experiments.dist}/${application.title}">
            <include name="build.xml"/>
            <replacetoken><![CDATA[<import file="../../build-tasks.xml"/>]]></replacetoken>
        </replace>
        <replace dir="${jfx.apps.experiments.dist}/${application.title}">
            <include name="build.xml"/>
            <replacetoken><![CDATA[${jfx.sdk.anttask.jar}]]></replacetoken>
            <replacevalue>../../../lib/ant-javafx.jar</replacevalue>
        </replace>
        <!-- Update JFXRT.jar path in NB Project -->
        <replace dir="${jfx.apps.experiments.dist}/${application.title}/nbproject"
                value="file.reference.jfxrt.jar=../../../rt/lib/ext/jfxrt.jar">
            <include name="project.properties"/>
            <replacetoken><![CDATA[file.reference.jfxrt.jar=../../../artifacts/sdk/rt/lib/ext/jfxrt.jar]]></replacetoken>
        </replace>
    </target>

    <target name="dist-apps-ga-samples" depends="init">
        <copy todir="${jfx.apps.ga-samples.dir}">
            <fileset dir="dist">
                <include name="*.jar"/> <!-- should be good to copy -->
                <include name="*.html"/>
                <include name="*.jnlp"/>
                <include name="web-files/*"/>
            </fileset>
        </copy>

        <!-- Copy src files -->
        <mkdir dir="${jfx.apps.ga-samples.dist}/${application.title}"/>
        <copy todir="${jfx.apps.ga-samples.dist}/${application.title}">
            <fileset dir="${basedir}">
                <exclude name="**/build/**"/>
                <exclude name="**/dist/**"/>
                <exclude name="**/nbproject/private/**"/>
                <exclude name="**/*.iml"/>
            </fileset>
        </copy>

        <!-- Remove build-tasks import from netbeans projects -->
        <replace dir="${jfx.apps.ga-samples.dist}/${application.title}">
            <include name="build.xml"/>
            <replacetoken><![CDATA[<import file="../../build-tasks.xml"/>]]></replacetoken>
        </replace>
        <replace dir="${jfx.apps.ga-samples.dist}/${application.title}">
            <include name="build.xml"/>
            <replacetoken><![CDATA[${jfx.sdk.anttask.jar}]]></replacetoken>
            <replacevalue>../../../lib/ant-javafx.jar</replacevalue>
        </replace>
        <!-- Update JFXRT.jar path in NB Project -->
        <replace dir="${jfx.apps.ga-samples.dist}/${application.title}/nbproject"
                value="file.reference.jfxrt.jar=../../../rt/lib/ext/jfxrt.jar">
            <include name="project.properties"/>
            <replacetoken><![CDATA[file.reference.jfxrt.jar=../../../artifacts/sdk/rt/lib/ext/jfxrt.jar]]></replacetoken>
        </replace>
    </target>

    <target name="dist-apps-internal" depends="init">
        <!-- Generate html/gtml and copy them -->
        <antcall target="web-deploy">
           <param name="dt.path" value="../.."/>
        </antcall>
        <copy todir="${jfx.apps.internal.dir}" overwrite="true">
            <fileset dir="dist">
                <include name="*.html"/>
                <include name="*.jnlp"/>
                <include name="web-files/*"/>
            </fileset>
        </copy>

        <!-- CREATE A RUNNABLE JAR FILE -->
        <fx:jar destfile="${jfx.apps.internal.dir}/${application.title}.jar">
            <fx:application mainClass="${main.class}"/>
            <fileset dir="build/classes"/>
            <manifest>
              <!-- Who is building this jar? -->
              <attribute name="Built-By" value="JavaFX Build"/>
              <!-- Information about the program itself -->
              <attribute name="Implementation-Vendor" value="Oracle"/>
              <attribute name="Implementation-Title" value="${application.title}"/>
              <attribute name="Implementation-Version" value="1.0"/>
            </manifest>
        </fx:jar>
    </target>
	
    <target name="dist-app-internal-jar-only" depends="init">
        <copy file="dist/${application.title}.jar" todir="${jfx.apps.internal.dir}"/>
    </target>

</project>

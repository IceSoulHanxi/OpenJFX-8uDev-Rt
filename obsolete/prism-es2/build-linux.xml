<?xml version="1.0" encoding="UTF-8"?>
<project name="prism-es2" default="all" basedir=".">

  <property name="prism-es2.classes.dir" value="../prism-es2-x11/build/classes"/>
  <property name="prism-common.classes.dir" value="../../rt/prism-common/build/classes/"/>

  <property name="prism-es2.lib.file" value="${native.dist.dir}/libprism-es2.so"/>
  <property name="prism-es2.eglfb.lib.file" value="${native.dist.dir}/libprism-es2-eglfb.so"/>
  <property name="prism-es2.eglx11.lib.file" value="${native.dist.dir}/libprism-es2-eglx11.so"/>

  <property name="cpp.dir" value="../prism-es2-native"/>

  <uptodate property="native.x11.uptodate" targetfile="${prism-es2.lib.file}">
      <srcfiles dir="${cpp.dir}/src" includes="**/*.c"/>
      <srcfiles dir="${cpp.dir}/src" includes="**/*.h"/>
      <!-- Platform specific source files -->
      <srcfiles dir="${cpp.dir}/src/x11" includes="*.c"/>
  </uptodate>

  <uptodate property="native.eglx11.uptodate" targetfile="${prism-es2.eglx11.lib.file}">
      <srcfiles dir="${cpp.dir}/src" includes="**/*.c"/>
      <srcfiles dir="${cpp.dir}/src" includes="**/*.h"/>
      <!-- Platform specific source files -->
      <srcfiles dir="${cpp.dir}/src/eglx11" includes="*.c"/>
   </uptodate>

   <uptodate property="native.eglfb.uptodate" targetfile="${prism-es2.eglfb.lib.file}">
      <srcfiles dir="${cpp.dir}/src" includes="**/*.c"/>
      <srcfiles dir="${cpp.dir}/src" includes="**/*.h"/>
      <!-- Platform specific source files -->
      <srcfiles dir="${cpp.dir}/src/eglfb" includes="*.c"/>
   </uptodate>

   <condition property="build.native.host">
       <and>
           <not>
               <isset property="native.x11.uptodate"/>
           </not>
           <not>
               <isset property="isCrossPlatform"/>
           </not>
       </and>
   </condition>

  <target name="compile-native-eglfb" if="${cross.build.EGL.FB}" unless="native.eglfb.uptodate">
    <fail unless="cross.rt.es2.eglfb.cflags" message="Missing cross.rt.es2.eglfb.cflags definition"/>
    <fail unless="cross.rt.es2.eglfb.ldflags" message="Missing cross.rt.es2.eglfb.ldflags definition"/>
    <exec executable="make" dir="../prism-es2-native" failonerror="true">
      <arg value="JDK_HOME=${platform.home}"/>
      <arg value="DIST_DIR=${native.dist.dir}"/>
      <arg value="BUILD_DIR=${native.build.dir}/eglfb/"/>

      <arg value="PRISMES2_LIB=${prism-es2.eglfb.lib.file}"/>
      <arg value="PRISMES2_LINK_LIBS=${cross.rt.es2.eglfb.ldflags}"/>
      <arg value="PRISMES2_NATIVE_SRC=src/eglfb"/>
      <arg value="PRISMES2_PLATFORM_CLASS_DIR=../prism-es2-eglfb/build/classes"/>
      <arg value="PRISMES2_PLATFORM_PKG=com.sun.prism.es2"/>

      <arg value="CC=${crosstools.gcc}"/>
      <arg value="EXTRA_CFLAGS=${cross.rt.es2.eglfb.cflags}"/>
      <arg value="LINK=${crosstools.gcc}"/>
      <arg value="all"/>
    </exec>
  </target>

  <target name="compile-native-eglx11" if="${cross.build.EGL.X11}" unless="native.eglx11.uptodate">
    <fail unless="cross.rt.es2.eglx11.cflags" message="Missing cross.rt.es2.eglx11.cflags definition"/>
    <fail unless="cross.rt.es2.eglx11.ldflags" message="Missing cross.rt.es2.eglx11.ldflags definition"/>
    <exec executable="make" dir="../prism-es2-native" failonerror="true">
      <arg value="JDK_HOME=${platform.home}"/>
      <arg value="DIST_DIR=${native.dist.dir}"/>
      <arg value="BUILD_DIR=${native.build.dir}/eglx11/"/>

      <arg value="PRISMES2_LIB=${prism-es2.eglx11.lib.file}"/>
      <arg value="PRISMES2_LINK_LIBS=${cross.rt.es2.eglx11.ldflags}"/>
      <arg value="PRISMES2_NATIVE_SRC=src/eglx11"/>
      <arg value="PRISMES2_PLATFORM_CLASS_DIR=../prism-es2-eglx11/build/classes"/>
      <arg value="PRISMES2_PLATFORM_PKG=com.sun.prism.es2"/>

      <arg value="CC=${crosstools.gcc}"/>
      <arg value="EXTRA_CFLAGS=${cross.rt.es2.eglx11.cflags}"/>
      <arg value="LINK=${crosstools.gcc}"/>
      <arg value="all"/>
    </exec>
  </target>

  <target name="compile-native-host" if="build.native.host">
    <exec executable="make" dir="../prism-es2-native" failonerror="true">
      <arg value="JDK_HOME=${platform.home}"/>
      <arg value="DIST_DIR=${native.dist.dir}"/>
      <arg value="BUILD_DIR=${native.build.dir}"/>

      <!--
      <arg value="PRISMES2_CLASS_DIR=../prism-es2/build/classes"/>
      <arg value="PRISM_DEP_CP=${prism-common.classes.dir}"/>
      -->

      <arg value="all"/>
    </exec>
  </target>

  <target name="compile-native" depends="compile-native-host,compile-native-eglx11,compile-native-eglfb"/>

  <target name="clean-native" >
    <exec executable="make" dir="../prism-es2-native" failonerror="true">
      <arg value="DIST_DIR=${native.dist.dir}"/>
      <arg value="BUILD_DIR=${native.build.dir}"/>
      <arg value="clean"/>
    </exec>
  </target>

</project>

<?xml version="1.0" encoding="UTF-8"?>
<project name="jfxwebkit" default="dist" basedir=".">
    <description>Builds Webkit Java port</description>

    <import file="../../build-defs.xml"/>
    <property file="project.properties"/>

    <condition property="webkit.config" value="Debug" else="Release">
        <isset property="webkit.debug"/>
    </condition>

    <condition property="build.dir" value="WebKitBuild" else="WebKitBuild.${cross.platform}">
            <not><isset property="cross.platform"/></not>
    </condition>

    <property name="build.webkit.dir" value="${build.dir}/${webkit.config}"/>
    <property name="webkit.lib.dir" value="WebKitLibraries"/>
    <property name="gen.java.dir" value="${build.webkit.dir}/WebCore/generated/java"/>
    <property name="build.classes.dir" value="${build.dir}/classes"/>
    <property name="dist.dir" value="dist"/>
    <property name="jar.name" value="${ant.project.name}.jar"/>
    <property name="webkit.library.name" value="${ant.project.name}"/>
    <property name="drt.library.name" value="DumpRenderTreeJava"/>

    <patternset id="webkit.library">
        <include name="${webkit.library.name}.dll"/>
        <include name="lib${webkit.library.name}.dylib"/>
        <include name="lib${webkit.library.name}.so"/>
    </patternset>

    <patternset id="drt.library">
        <include name="${drt.library.name}.dll"/>
        <include name="lib${drt.library.name}.dylib"/>
        <include name="lib${drt.library.name}.so"/>
    </patternset>

    <target name="build-native">
        <ant antfile="build-native.xml" target="build"/>
    </target>

    <target name="jar" depends="build-native">
        <mkdir dir="${build.classes.dir}"/>
        <copy todir="${gen.java.dir}/com/sun/webkit/dom"
              file="Source/WebCore/bindings/java/EventListenerImpl.java"/>

        <javac compiler="modern"
             destdir="${build.classes.dir}"
             debug="${javac.debug}"
             debuglevel="${javac.debuglevel}"
             deprecation="${javac.deprecation}"
             source="${javac.source}"
             target="${javac.target}"
             includeantruntime="false"
             encoding="${source.encoding}"
             srcdir="${gen.java.dir}">
            <classpath>
                <path path="${javac.classpath}"/>
            </classpath>
            <compilerarg line="${javac.compilerargs}"/>
        </javac>

        <copy todir="${build.classes.dir}">
            <fileset dir="${gen.java.dir}" excludes="**/*.java"/>
        </copy>

        <mkdir dir="${dist.dir}"/>
        <jar destfile="${dist.dir}/${ant.project.name}.jar">
            <fileset dir="${build.classes.dir}"/>
        </jar>
    </target>

    <target name="dist" depends="build-native,jar">
        <copy todir="${jfx.sdk.desktop.dir}" flatten="true">
            <fileset file="${dist.dir}/${jar.name}"/>
            <fileset dir="${build.webkit.dir}/lib">
                <patternset refid="webkit.library"/>
            </fileset>
            <fileset dir="${webkit.lib.dir}">
                <include name="import/runtime/*"/>
            </fileset>
        </copy>
        <copy todir="${jfx.test.dir}" flatten="true">
            <fileset dir="${build.webkit.dir}/lib">
                <patternset refid="drt.library"/>
            </fileset>
        </copy>
    </target>

    <target name="clean">
        <delete dir="${build.webkit.dir}"/>
        <delete dir="${build.dir}/Tools"/>
        <delete dir="${build.classes.dir}"/>
        <delete dir="${dist.dir}"/>
        <delete dir="${webkit.lib.dir}/import"/>
    </target>

    <!-- Framework wiring -->

    <target name="jfx-clean" depends="clean"/>

    <target name="jfx-clean-sdk">
        <delete>
            <fileset dir="${jfx.sdk.desktop.dir}">
                <patternset includes="${jar.name}"/>
                <patternset refid="webkit.library"/>
                <patternset includes="libxml2.*"/>
                <patternset includes="libxslt.*"/>
            </fileset>
            <fileset dir="${jfx.test.dir}">
                <patternset refid="drt.library"/>
            </fileset>
        </delete>
    </target>

    <target name="jfx-sdk" depends="dist"/>

    <target name="jfx-sdk-docs"/>
    <target name="jfx-deploy"/>
    <target name="jfx-clean-deploy"/>
    <target name="jfx-test"/>
    <target name="jfx-full-test"/>
    <target name="jfx-perf"/>
    <target name="jfx-apps"/>

</project>
